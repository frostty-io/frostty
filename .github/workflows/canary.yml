name: canary

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: canary-${{ github.ref }}
  cancel-in-progress: true

jobs:
  canary:
    name: canary
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compute canary metadata
        id: canary_meta
        run: |
          BUILD_DATE_ISO="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          BUILD_DATE_TAG="$(date -u +'%Y%m%d-%H%M')"
          BUILD_DATE_NAME="$(date -u +'%Y-%m-%d %H:%M UTC')"
          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="canary-${BUILD_DATE_TAG}-${SHORT_SHA}"
          RELEASE_NAME="Canary ${BUILD_DATE_NAME}"

          echo "build_date_iso=${BUILD_DATE_ISO}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Lint
        run: pnpm run lint

      - name: Unit tests
        run: pnpm exec vitest run --coverage --reporter=default --reporter=junit --outputFile.junit=./test-results/junit.xml

      - name: Build
        env:
          FROSTTY_BUILD_SHA: ${{ steps.canary_meta.outputs.short_sha }}
          FROSTTY_BUILD_DATE: ${{ steps.canary_meta.outputs.build_date_iso }}
        run: pnpm run build

      - name: Validate Apple signing secrets
        env:
          APPLE_SIGNING_CERT: ${{ secrets.APPLE_SIGNING_CERT }}
          APPLE_SIGNING_CERT_PASSWORD: ${{ secrets.APPLE_SIGNING_CERT_PASSWORD }}
        run: |
          missing=0
          for name in APPLE_SIGNING_CERT APPLE_SIGNING_CERT_PASSWORD; do
            if [ -z "${!name}" ]; then
              echo "::error::Missing required secret: ${name}"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Configure required notarization via API key
        env:
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
        run: |
          missing=0
          for name in APPLE_API_KEY APPLE_API_KEY_ID APPLE_API_ISSUER; do
            if [ -z "${!name}" ]; then
              echo "::error::Missing required secret for API-key notarization: ${name}"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

          APPLE_API_KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_API_KEY_ID}.p8"
          printf '%s' "$APPLE_API_KEY" > "$APPLE_API_KEY_PATH"
          chmod 600 "$APPLE_API_KEY_PATH"

          echo "APPLE_API_KEY=$APPLE_API_KEY_PATH" >> "$GITHUB_ENV"
          echo "APPLE_API_KEY_ID=${APPLE_API_KEY_ID}" >> "$GITHUB_ENV"
          echo "APPLE_API_ISSUER=${APPLE_API_ISSUER}" >> "$GITHUB_ENV"

      - name: Package macOS artifacts (signed)
        env:
          CSC_LINK: ${{ secrets.APPLE_SIGNING_CERT }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_SIGNING_CERT_PASSWORD }}
        run: pnpm exec electron-builder --mac --publish never

      - name: Validate notarization ticket
        run: |
          set -euo pipefail

          APP_PATH="$(find dist -type d -name '*.app' | head -n 1)"
          if [ -z "${APP_PATH}" ]; then
            echo "::error::No .app bundle found under dist/"
            exit 1
          fi

          xcrun stapler validate "${APP_PATH}"

      - name: Generate checksums
        run: |
          rm -f dist/SHA256SUMS.txt
          while IFS= read -r -d '' file; do
            shasum -a 256 "$file" >> dist/SHA256SUMS.txt
          done < <(find dist -type f \( -name '*.dmg' -o -name '*.zip' \) -print0)

      - name: Create GitHub prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.canary_meta.outputs.tag }}
          name: ${{ steps.canary_meta.outputs.release_name }}
          prerelease: true
          fail_on_unmatched_files: false
          files: |
            dist/*.dmg
            dist/*.zip
            dist/*.blockmap
            dist/latest*.yml
            dist/SHA256SUMS.txt

      - name: Cleanup old canary releases
        uses: actions/github-script@v7
        env:
          KEEP_CANARY: '20'
        with:
          script: |
            const keep = Number(process.env.KEEP_CANARY || '20')
            const { owner, repo } = context.repo
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner,
              repo,
              per_page: 100
            })

            const canaries = releases
              .filter((release) => release.tag_name && release.tag_name.startsWith('canary-'))
              .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())

            const toDelete = canaries.slice(keep)
            core.info(`Found ${canaries.length} canary releases, deleting ${toDelete.length}.`)

            for (const release of toDelete) {
              core.info(`Deleting release ${release.tag_name}`)
              await github.rest.repos.deleteRelease({ owner, repo, release_id: release.id })
              try {
                await github.rest.git.deleteRef({ owner, repo, ref: `tags/${release.tag_name}` })
              } catch (error) {
                core.warning(`Could not delete tag ${release.tag_name}: ${error.message}`)
              }
            }
